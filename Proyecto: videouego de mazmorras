#include <stdio.h>
#include <stdlib.h>
#include <time.h>

void limpiar_consola() {
    printf("\033[H\033[J");
}

void bienvenida(char nombre[20]) {
    while (1) {
        puts("Bienvenido jugador. Ingrese su nombre: ");
        scanf("%s", nombre);
        limpiar_consola();
        break;
    }
}

void rellenarMazmorras(int tamañomazmorra, char dungeon[tamañomazmorra][tamañomazmorra], int dificultad) {
    srand(time(NULL));
    int r;
    char enemigos[2] = {'1', '2'};
    for (int i = 0; i < tamañomazmorra; i++) {
        for (int j = 0; j < tamañomazmorra; j++) {
            r = rand() % 10;
            if (r > dificultad) {
                dungeon[i][j] = '*';
            } else {
                dungeon[i][j] = enemigos[rand() % 2];
            }
        }
    }
}

void imprimirMazmorra(int tamañomazmorra, char dungeon[tamañomazmorra][tamañomazmorra], int fila, int columna) {
    for (int i = fila - 1; i <= fila + 1; i++) {
        for (int j = columna - 1; j <= columna + 1; j++) {
            if (i >= 0 && i < tamañomazmorra && j >= 0 && j < tamañomazmorra) {
                printf("%c ", dungeon[i][j]);
            } else {
                printf("  ");
            }
        }
        printf("\n");
    }
}

void actualizar_mazmorra(int n, char mazmorra[n][n], int fila, int columna, int fila_nueva, int columna_nueva, char *original) {
    mazmorra[fila][columna] = *original; // Restaurar el valor original
    *original = mazmorra[fila_nueva][columna_nueva]; // Guardar el valor de la nueva casilla
    mazmorra[fila_nueva][columna_nueva] = '5'; // Mover al jugador
}

int movimientos(int Nmazmorra, int tamañomazmorra, char mazmorra[tamañomazmorra][tamañomazmorra], char jugador) {
    srand(time(NULL));
    int fila = rand() % Nmazmorra;
    int columna = rand() % Nmazmorra;
    int nuevafila = fila;
    int nuevacolumna = columna;
    char movimiento;
    char original = mazmorra[fila][columna];
    mazmorra[fila][columna] = jugador;
    limpiar_consola();
    imprimirMazmorra(tamañomazmorra, mazmorra, fila, columna);
    while (1) {
        scanf(" %c", &movimiento);
        if (movimiento == 'w') {
            nuevafila = fila - 1;
            nuevacolumna = columna;
        } else if (movimiento == 'a') {
            nuevafila = fila;
            nuevacolumna = columna - 1;
        } else if (movimiento == 's') {
            nuevafila = fila + 1;
            nuevacolumna = columna;
        } else if (movimiento == 'd') {
            nuevafila = fila;
            nuevacolumna = columna + 1;
        } else {
            limpiar_consola();
            imprimirMazmorra(tamañomazmorra, mazmorra, fila, columna);
            puts("Opción inválida");
            continue;
        }
        if (nuevafila < 0 || nuevafila >= Nmazmorra || nuevacolumna < 0 || nuevacolumna >= Nmazmorra) {
            puts("Movimiento fuera de los límites.");
            continue;
        }
        actualizar_mazmorra(tamañomazmorra, mazmorra, fila, columna, nuevafila, nuevacolumna, &original);
        fila = nuevafila;
        columna = nuevacolumna;
        limpiar_consola();
        imprimirMazmorra(tamañomazmorra, mazmorra, fila, columna);
    }
    return 0;
}

void opcion2() {
    limpiar_consola();
    puts("┌────────────────────────────────┐");
    puts("│    Reglas del juego:           │");
    puts("├────────────────────────────────┤");
    puts("│- Tienes que llegar hasta       │");
    puts("│  la mazmorra 3 y vencer al     │");
    puts("│  jefe.                         │");
    puts("│                                │");
    puts("│- En cada mazmorra              │");
    puts("│  habrán enemigos que           │");
    puts("│  tratarán de matarte           │");
    puts("│                                │");
    puts("│- También habrán                │");
    puts("│  objetos que mejorarán tus     │");
    puts("│  capacidades, como la vida     │");
    puts("│  o la fuerza.                  │");
    puts("└───────────────────────────────┘");
    puts("Presiona Enter para salir");
    getchar();
    limpiar_consola();
}

void opcion3() {
    limpiar_consola();
    puts("        ┌─────┐               w: moverte hacia arriba");
    puts("        │  w  │");
    puts("        └─────┘               a: moverte hacia la izquierda");
    puts("┌─────┐ ┌─────┐  ┌─────┐");
    puts("│  a  │ │  s  │  │  d  │      s: moverte hacia abajo");
    puts("└─────┘ └─────┘  └─────┘");
    puts("                              d: moverte hacia la derecha");
    puts("Presiona Enter para salir");
    getchar();
    limpiar_consola();
}

void opcion4() {
    limpiar_consola();
    puts("1: Tiene x cantidad de vida. Te quita x cantidad de vida");
    puts("2: Tiene x cantidad de vida. Te quita x cantidad de vida");
    puts("Presiona Enter para salir");
    getchar();
    limpiar_consola();
}

void opcion5() {
    limpiar_consola();
    puts("3: te da un aumento de vida de x cantidad");
    puts("4: te da un aumento de vida de x cantidad");
    puts("Presiona Enter para salir");
    getchar();
    limpiar_consola();
}

void mostrarMenu() {
    puts("  Menú:");
    puts("  1. Jugar");
    puts("  2. Reglas");
    puts("  3. Controles");
    puts("  4. Enemigos");
    puts("  5. Items");
    puts("  6. Salir");
}

int main(int argc, char *argv[]) {
    char jugador = '5';
    char mazmorra1[15][15];
    int opcion;
    char nombre[20];
    
    puts("┌──────────────────────────────────────┐");
    puts("│           Juego de Mazmorra           │");
    puts("└───────────────────────────────────────┘");
    bienvenida(nombre);
    limpiar_consola();
    mostrarMenu();
    
    while (1) {
        printf("Ingrese una opción: ");
        if (scanf("%d", &opcion) != 1) {
            // Limpiar el buffer de entrada en caso de entrada no válida
            while (getchar() != '\n');
            puts("Opción inválida. Por favor, ingrese una opción válida.");
            continue;
        }
        
        getchar(); // Captura el Enter después de ingresar la opción
        
        switch (opcion) {
            case 1:
                limpiar_consola();
                rellenarMazmorras(15, mazmorra1, 4);
                movimientos(15, 15, mazmorra1, jugador);
                limpiar_consola();
                mostrarMenu();
                break;
            case 2:
                opcion2();
                limpiar_consola();
                mostrarMenu();
                break;
            case 3:
                opcion3();
                limpiar_consola();
                mostrarMenu();
                break;
            case 4:
                opcion4();
                limpiar_consola();
                mostrarMenu();
                break;
            case 5:
                opcion5();
                limpiar_consola();
                mostrarMenu();
                break;
            case 6:
                limpiar_consola();
                puts("Saliendo...");
                return 0;
            default:
                puts("Opción inválida. Por favor, ingrese una opción válida.");
                break;
        }
    }
    
    return 0;
}
